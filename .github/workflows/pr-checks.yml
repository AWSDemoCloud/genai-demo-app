name: PR Checks & Autoâ€‘Docs

on:
  pull_request:

permissions:
  id-token: write          # OIDC for AWS
  contents: read           # checkout / diff
  pull-requests: write     # let the autoâ€‘docs job push commits

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    name: Build & Jest
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true      # demo keeps flowing even on red tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node (LTS) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            app/package-lock.json

      - name: Install deps
        working-directory: app
        run: |
          npm ci --no-audit --no-fund --loglevel=error

      - name: Run Jest (forceâ€‘exit)
        working-directory: app
        run: |
          npm test -- --runInBand --detectOpenHandles --forceExit || true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  auto-docs:
    name: Generate Docs via Bedrock
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Debug info (size of diff + jq path) ---------------
      - name: Preâ€‘flight debug
        run: |
          which jq || true
          echo "jq version:" $(jq --version || echo "missing")
          echo "HEAD is" $(git rev-parse --short HEAD)

      # --- Configure AWS creds via OIDC ----------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: docs-bot-${{ github.run_id }}
          aws-region: ${{ secrets.AWS_REGION }}

      # --- Build a robust diff -------------------------------
      - name: Create diff file
        run: |
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
          git fetch origin ${{ github.head_ref }}:${{ github.head_ref }}
          git checkout ${{ github.head_ref }}
          git diff --text --diff-filter=d ${{ github.base_ref }}...${{ github.head_ref }} > diff.txt || true  # <-- KEY CHANGE HERE
      
          if [[ ! -s diff.txt ]]; then
            echo "No merge-base diff; using HEAD~1."
            git diff --text HEAD~1 > diff.txt || true
          fi
      
          # Add binary check
          if file -I "diff.txt" | grep -q -v "text/"; then
            echo "ERROR: Diff contains binary data!"
            exit 1
          fi
      
          echo "First 10 lines of diff:"
          head -n 10 diff.txt || true
          echo "Diff size:" $(stat -c%s diff.txt || echo 0) "bytes"

      # --- Invoke Bedrock agent / model ----------------------
      - name: Generate documentation via Bedrock
        if: ${{ hashFiles('diff.txt') != '' }}
        run: |
          chmod +x scripts/invoke-bedrock-agent.sh
          ./scripts/invoke-bedrock-agent.sh diff.txt doc.md

      # --- Commit autoâ€‘generated docs ------------------------
      - name: Commit documentation
        if: success() && ${{ hashFiles('doc.md') != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name  "rahulladumor-ai"
          git config --global user.email "ladumorrahul56@gmail.com"
          if [ -f doc.md ]; then
            git add doc.md
            git commit -m "ðŸ¤– Auto-generated docs via Bedrock" || echo "Nothing to commit"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No doc.md to commit."
          fi
      
