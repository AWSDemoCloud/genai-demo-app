name: PR Checks

on:
  pull_request:

permissions:
  id-token: write      # âœ… OIDC
  contents: read       # âœ… checkout / diff
  pull-requests: write # âœ… allow autoâ€‘docs job to push commits & comments

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    name: Build & Jest Tests
    runs-on: ubuntu-latest
    continue-on-error: true        # <-- keep the demo flowing even on failure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node (LTS) & cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            app/package-lock.json

      - name: Install deps & run tests
        working-directory: app
        run: |
          npm ci
          npm test -- --runInBand --detectOpenHandles --forceExit || true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  auto-docs:
    name: Generate Docs via Bedrock
    runs-on: ubuntu-latest
    needs: build-and-test           # still runs even if previous job failed
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- AWS OIDC authentication ---
      - name: Configure AWS credentials (OIDC)
        id: aws-creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: docs-bot-${{ github.run_id }}
          aws-region: ${{ secrets.AWS_REGION }}

      # --- Generate diff of PR changes ---
      - name: Create diff file
        run: |
          # Ensure we have the full history for merge-base calculation
          git fetch --no-tags --prune --progress --no-recurse-submodules --depth=0 origin ${{ github.base_ref }}
          
          # Use GitHub vars so it works with non-main default branches
          BASE_REF="origin/${{ github.base_ref }}"
          HEAD_REF="${{ github.head_ref }}"
          
          echo "Diffing $BASE_REF...$HEAD_REF"
          git diff --binary "$BASE_REF...$HEAD_REF" > diff.txt || true
          
          if [ ! -s diff.txt ]; then
            echo "No diff generated (possibly first commit). Falling back to HEAD~1."
            git diff --binary HEAD~1 > diff.txt || true
          fi

      # --- Quick preview (optional) ---
      - name: Preview first 20 lines of diff
        run: head -n 20 diff.txt

      # --- Invoke Bedrock agent ---
      - name: Run Bedrock doc agent
        run: |
          chmod +x scripts/invoke-bedrock-agent.sh
          ./scripts/invoke-bedrock-agent.sh diff.txt doc.md

      # --- Commit docs back to PR branch ---
      - name: Commit generated docs
        if: success() && (hashFiles('doc.md') != '')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name  "doc-bot"
          git config --global user.email "doc-bot@genai-demo.local"
          git checkout ${{ github.head_ref }}
          git add doc.md
          git commit -m "ðŸ¤– Auto-generated docs via Bedrock Agent" || echo "Nothing to commit"
          git push origin ${{ github.head_ref }}
