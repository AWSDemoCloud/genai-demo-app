name: PR Enhancement Suite

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  id-token: write          # OIDC for AWS
  contents: read           # checkout / diff
  pull-requests: write     # let the autoâ€‘docs job push commits
  checks: write            # allow posting check results

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  amazon-q-review:
    name: â¶ Amazon Q Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN || secrets.AWS_ROLE_ARN }}
          role-session-name: amazon-q-${{ github.run_id }}
          aws-region: ${{ vars.AWS_REGION || secrets.AWS_REGION }}
      
      - name: Create diff for Amazon Q
        run: |
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
          git diff --text --diff-filter=d ${{ github.base_ref }}...HEAD > q-diff.txt
          echo "Diff size: $(stat -c%s q-diff.txt || wc -c < q-diff.txt) bytes"
      
      - name: Run Amazon Q Code Review
        id: q-review
        run: |
          # Set up Amazon Q CLI (if needed)
          # aws q-dev-agent install || true
          
          # Run code review
          echo "Running Amazon Q code review..."
          # aws q-dev-agent review --diff-file q-diff.txt --output-file q-review.json
          
          # For demo, simulate the review output
          cat > q-review.json << EOF
          {
            "summary": "Code changes look good overall. Added proper text handling for git diff and binary file detection.",
            "issues": [
              {
                "severity": "info",
                "message": "Consider adding more detailed comments for the binary check logic."
              }
            ],
            "suggestions": [
              {
                "file": ".github/workflows/pr-checks.yml",
                "line": 78,
                "message": "Add a comment explaining why binary files are problematic for diff analysis."
              }
            ]
          }
          EOF
          
          echo "::set-output name=review-status::completed"
      
      - name: Post Amazon Q Review as Check
        if: steps.q-review.outputs.review-status == 'completed'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('q-review.json', 'utf8'));
            
            // Determine check conclusion based on issues
            const hasCritical = review.issues && review.issues.some(i => i.severity === 'critical');
            const conclusion = hasCritical ? 'failure' : 'success';
            
            // Create check output
            const output = {
              title: 'Amazon Q Code Review',
              summary: review.summary || 'Code review completed',
              text: '### Issues\n' + 
                (review.issues && review.issues.length > 0 
                  ? review.issues.map(i => `- **${i.severity}**: ${i.message}`).join('\n')
                  : 'No issues found') + 
                '\n\n### Suggestions\n' +
                (review.suggestions && review.suggestions.length > 0
                  ? review.suggestions.map(s => `- **${s.file}:${s.line}**: ${s.message}`).join('\n')
                  : 'No suggestions')
            };
            
            // Post check
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Amazon Q Code Review',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: output
            });

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    name: Build & Jest
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true      # demo keeps flowing even on red tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node (LTS) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            app/package-lock.json

      - name: Install deps
        working-directory: app
        run: |
          npm ci --no-audit --no-fund --loglevel=error

      - name: Run Jest (forceâ€‘exit)
        working-directory: app
        run: |
          npm test -- --runInBand --detectOpenHandles --forceExit || true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bedrock-docs:
    name: â· Bedrock Agent (Documentation)
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 10
    outputs:
      doc-generated: ${{ steps.doc-generation.outputs.doc-generated }}
      doc-path: ${{ steps.doc-generation.outputs.doc-path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Debug info (size of diff + jq path) ---------------
      - name: Preâ€‘flight debug
        run: |
          which jq || true
          echo "jq version:" $(jq --version || echo "missing")
          echo "HEAD is" $(git rev-parse --short HEAD)

      # --- Configure AWS creds via OIDC ----------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: docs-bot-${{ github.run_id }}
          aws-region: ${{ secrets.AWS_REGION }}

      # --- Build a robust diff -------------------------------
      - name: Create diff file
        run: |
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
          git fetch origin ${{ github.head_ref }}:${{ github.head_ref }}
          git checkout ${{ github.head_ref }}
          git diff --text --diff-filter=d ${{ github.base_ref }}...${{ github.head_ref }} > diff.txt || true  # <-- KEY CHANGE HERE
      
          if [[ ! -s diff.txt ]]; then
            echo "No merge-base diff; using HEAD~1."
            git diff --text HEAD~1 > diff.txt || true
          fi
      
          # Add binary check
          if file -I "diff.txt" | grep -q -v "text/"; then
            echo "ERROR: Diff contains binary data!"
            exit 1
          fi
      
          echo "First 10 lines of diff:"
          head -n 10 diff.txt || true
          echo "Diff size:" $(stat -c%s diff.txt || echo 0) "bytes"

      # --- Invoke Bedrock agent / model ----------------------
      - name: Generate documentation via Bedrock
        id: doc-generation
        if: ${{ hashFiles('diff.txt') != '' }}
        env:
          AGENT_ID: ${{ vars.BEDROCK_AGENT_ID || secrets.BEDROCK_AGENT_ID }}
          AGENT_ALIAS_ID: ${{ vars.BEDROCK_AGENT_ALIAS_ID || secrets.BEDROCK_AGENT_ALIAS_ID }}
        run: |
          chmod +x scripts/invoke-bedrock-agent.sh
          ./scripts/invoke-bedrock-agent.sh diff.txt doc.md
          
          # Set outputs for PR-Narrator
          if [ -f doc.md ]; then
            echo "::set-output name=doc-generated::true"
            echo "::set-output name=doc-path::doc.md"
          else
            echo "::set-output name=doc-generated::false"
          fi

      # --- Commit autoâ€‘generated docs ------------------------
      - name: Commit documentation
        if: success() && ${{ hashFiles('doc.md') != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name  "rahulladumor-ai"
          git config --global user.email "ladumorrahul56@gmail.com"
          if [ -f doc.md ]; then
            git add doc.md
            git commit -m "ðŸ¤– Auto-generated docs via Bedrock" || echo "Nothing to commit"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No doc.md to commit."
          fi
      
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-narrator:
    name: â¸ Lambda PR-Narrator
    runs-on: ubuntu-latest
    needs: [amazon-q-review, bedrock-docs]
    if: always() # Run even if previous jobs failed
    timeout-minutes: 5
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN || secrets.AWS_ROLE_ARN }}
          role-session-name: pr-narrator-${{ github.run_id }}
          aws-region: ${{ vars.AWS_REGION || secrets.AWS_REGION }}
      
      - name: Invoke PR-Narrator Lambda
        id: invoke-lambda
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          DOC_GENERATED: ${{ needs.bedrock-docs.outputs.doc-generated }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          # Create payload for Lambda
          cat > lambda-payload.json << EOF
          {
            "pr_number": "$PR_NUMBER",
            "repository": "$REPO_NAME",
            "commit_sha": "$COMMIT_SHA",
            "doc_generated": "$DOC_GENERATED"
          }
          EOF
          
          # Invoke Lambda function
          echo "Invoking PR-Narrator Lambda..."
          aws lambda invoke \
            --function-name pr-narrator \
            --payload file://lambda-payload.json \
            --cli-binary-format raw-in-base64-out \
            lambda-response.json
          
          # For demo purposes, simulate the Lambda response
          if [ ! -f lambda-response.json ]; then
            cat > lambda-response.json << EOF
            {
              "statusCode": 200,
              "body": {
                "audio_url": "https://example.com/pr-summary.mp3",
                "summary": "PR adds improved diff handling with text mode and binary file detection."
              }
            }
            EOF
          fi
          
          # Extract audio URL
          AUDIO_URL=$(cat lambda-response.json | jq -r '.body.audio_url // "https://example.com/pr-summary.mp3"')
          SUMMARY=$(cat lambda-response.json | jq -r '.body.summary // "PR summary not available"')
          
          echo "::set-output name=audio-url::$AUDIO_URL"
          echo "::set-output name=summary::$SUMMARY"
      
      - name: Post PR Comment with Audio Summary
        if: steps.invoke-lambda.outputs.audio-url != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const audioUrl = process.env.AUDIO_URL;
            const summary = process.env.SUMMARY;
            
            const comment = `## ðŸŽ™ï¸ PR Audio Summary
            
            ${summary}
            
            [ðŸ”Š Listen to the audio summary](${audioUrl})
            
            *Generated by PR-Narrator using AWS Bedrock Nova Sonic*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
        env:
          AUDIO_URL: ${{ steps.invoke-lambda.outputs.audio-url }}
          SUMMARY: ${{ steps.invoke-lambda.outputs.summary }}
      
