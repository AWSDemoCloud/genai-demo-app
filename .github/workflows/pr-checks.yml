name: PR Checks

on:
  pull_request:

permissions:
  id-token: write           # âœ… Required for OIDC
  contents: read            # âœ… Needed to check out the code

jobs:
  build-test-q:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          cd app
          
          npm ci

      - name: Run tests (local fallback)
        run: |
          cd app
          npm test

  auto-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      # âœ… Authenticate to AWS via OIDC
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Generate a diff of code changes
      - name: Get PR diff
        run: |
          git fetch origin main
          git diff origin/main...HEAD > diff.txt

      # Optional: print the diff
      - name: View diff preview
        run: head -n 20 diff.txt

      # Invoke Bedrock agent to generate documentation
      - name: Generate documentation via Bedrock
        run: |
          chmod +x scripts/invoke-bedrock-agent.sh
          ./scripts/invoke-bedrock-agent.sh diff.txt doc.md

      # Commit auto-generated docs if they exist
      - name: Commit documentation
        if: success()
        run: |
          if [ -s doc.md ]; then
            git config --global user.name "doc-bot"
            git config --global user.email "doc-bot@genai-demo.local"
            git checkout ${{ github.head_ref }}
            git add doc.md
            git commit -m "ðŸ¤– auto-generated documentation via Bedrock Agent"
            git push origin ${{ github.head_ref }}
          else
            echo "No documentation generated by agent."
          fi
